#!/bin/sh /etc/rc.common

START=98
STOP=10
USE_PROCD=1
EXTRA_COMMANDS="status log install_deps remove_deps"
EXTRA_HELP="	status		Show nft rules applied by ttl-hotspot-changer
	log		Print limited log output
	install_deps	Run dependency helper (install)
	remove_deps	Run dependency helper (remove)"

CONFIG_NAME="ttl-hotspot-changer"
EXEC="/usr/libexec/ttl-hotspot-changer.sh"
DEPS_HELPER="/usr/libexec/ttl-hotspot-changer-depctl.sh"

. /lib/functions.sh

maybe_disable_rules() {
	"$EXEC" stop >/dev/null 2>&1
}

start_service() {
	local enabled=0

	config_load "$CONFIG_NAME"
	config_get_bool enabled config enable 0

	if [ "$enabled" -ne 1 ]; then
		logger -t ttl-hotspot-changer "Disabled via UCI, not starting"
		maybe_disable_rules
		return 1
	fi

	procd_open_instance
	procd_set_param command "$EXEC" start
	procd_set_param respawn 0 120 0
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}

stop_service() {
	maybe_disable_rules
}

stop() {
	local service_name="ttl-hotspot-changer"

	if command -v ubus >/dev/null 2>&1; then
		# Ignore "Not found" errors when the service has never been registered with procd.
		ubus -S call service delete "{\"name\":\"${service_name}\"}" >/dev/null 2>&1 || true
	fi

	stop_service
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$CONFIG_NAME"
}

status() {
	"$EXEC" status
}

log() {
	"$EXEC" log
}

install_deps() {
	"$DEPS_HELPER" install
}

remove_deps() {
	"$DEPS_HELPER" remove
}

